import{FileLoader as e,Loader as t,Mesh as r,Vector2 as a,Vector3 as i,Matrix4 as n,Vector4 as s,MathUtils as l,MeshPhongMaterial as u,MeshBasicMaterial as o,BufferGeometry as c,Quaternion as h,Plane as f,Shape as g,ShapeBufferGeometry as p,TextureLoader as m,RepeatWrapping as x,LinearEncoding as d,sRGBEncoding as M,FrontSide as R,DoubleSide as w,Group as y,BufferAttribute as B,EdgesGeometry as F,LineSegments as I,LineBasicMaterial as E,SphereGeometry as T}from"three";const D={FACET:1,VERTEX:2},V={POINTCLOUD:1,WIREFRAME:2,SOLID:3},G={LIT:1,FORESHORTEN:2,FILTER:3},b={NONE:0,NULL:1,DOUBLE:2},v=100,A=200;function C(e,t,r,a=d){return new Promise((i=>{r.load(e,(e=>{e.wrapS=x,e.wrapT=x,e.encoding=a,t.alphaMap=e,t.needsUpdate=!0,i(e)}))}))}function S(e,t,r,a=".jpg",i=null,n=".zip",s=null,l=null,u=[],o=M){let c=new m;if(u.push(new Promise((i=>{const n=t+"/"+r+a;c.load(n,(t=>{t.wrapS=x,t.wrapT=x,t.encoding=o,e.map=t,e.needsUpdate=!0,t.image.height!==t.image.width&&t.image.height%t.image.width==0&&(e.userData.rwx.animation={yTiles:t.image.height/t.image.width,yHeight:t.image.width/t.image.height,step:0},t.offset.y=1-e.userData.rwx.animation.yHeight,t.repeat.set(1,e.userData.rwx.animation.yHeight)),i(t)}))}))),null!=i)if(e.alphaTest=.2,e.transparent=!0,".zip"==n&&null!=s&&null!=l){const r=i,a=t+"/"+r+n;u.push(new s.external.Promise((function(e,t){l.getBinaryContent(a,(function(r,a){r?t(r):e(a)}))})).then(s.loadAsync).then((function(e){for(const[t]of Object.entries(e.files))if(t.toLowerCase()==r.toLowerCase()+".bmp")return e.file(t).async("uint8array")})).then((function(t){let r="data:image/bmp;base64,";let a="";for(let e=0;e<t.length;e+=4056)a=a.concat(String.fromCharCode.apply(null,new Uint16Array(t.slice(e,e+4056))));return r=r.concat(btoa(a)),C(r,e,c)}),(function(e){throw e})))}else if(".zip"!=n){const r=t+"/"+i+n;u.push(C(r,e,c))}}function L(e,t,r=".jpg",a=".zip",i=null,n=null,s=!1,l=M){let c={name:e.getMatSignature()};if(e.materialmode==b.NULL?c.side=R:e.materialmode==b.DOUBLE?c.side=w:e.materialmode==b.NONE&&(c.visible=!1),e.opacity<1&&(c.transparent=!0),e.geometrysampling<V.SOLID?c.wireframe=!0:c.wireframe=!1,!s){e.lightsampling==D.FACET?c.flatShading=!0:e.lightsampling==D.VERTEX&&(c.flatShading=!1);const t=Math.trunc(.1*e.surface[2]*255);c.specular=(t<<16)+(t<<8)+t;const r=Math.trunc(e.surface[1]);c.emissive=(r<<16)+(r<<8)+r,c.shininess=30}c.opacity=e.opacity;let h=s?new o(c):new u(c);h.userData.rwx={material:e.clone()};let f=[];h.userData.collision=e.collision,h.userData.ratio=e.ratio;const g=Math.max(...e.surface);return null==e.texture?(h.color.set(e.getColorHexValue()).convertSRGBToLinear(),h.color.multiplyScalar(g)):(h.color.set(16777215).convertSRGBToLinear(),h.color.multiplyScalar(g),S(h,t,e.texture,r,e.mask,a,i,n,f,l)),{threeMat:h,loadingPromises:f}}function $(e){e.currentBufferFaceCount>0&&W(e),e.currentBufferGeometry=new c,e.currentBufferVertices=[],e.currentBufferUVs=[],e.currentBufferFaces=[],e.currentBufferFaceCount=0,e.currentBufferGroupFirstFaceID=0,e.previousMaterialID=null}function U(e){if(e.currentBufferFaceCount>0&&W(e),e.currentBufferFaces.length>0){e.currentBufferGeometry.setAttribute("position",new B(new Float32Array(e.currentBufferVertices),3)),e.currentBufferGeometry.setAttribute("uv",new B(new Float32Array(e.currentBufferUVs),2)),e.currentBufferGeometry.setIndex(e.currentBufferFaces),e.currentBufferGeometry.uvsNeedUpdate=!0,e.currentBufferGeometry.computeVertexNormals(),e.loadingPromises=e.loadingPromises.concat(e.materialManager.getCommitedMaterialList().map((e=>e.loadingPromises)));const t=new r(e.currentBufferGeometry,e.materialManager.getCommitedMaterialList().map((e=>e.threeMat)));t.userData.taggedMaterials=e.taggedMaterials,e.currentGroup.add(t),re(e),ie(e),e.taggedMaterials={}}}function W(e){e.currentBufferGeometry.addGroup(e.currentBufferGroupFirstFaceID,3*e.currentBufferFaceCount,e.previousMaterialID),e.materialManager.commitMaterials(),e.previousMaterialID=e.materialManager.getCurrentMaterialID(),e.currentBufferGroupFirstFaceID=e.currentBufferGroupFirstFaceID+3*e.currentBufferFaceCount,e.currentBufferFaceCount=0}function X(e,t,r,a){e.materialManager.getCurrentMaterialID()!==e.previousMaterialID&&W(e),e.currentBufferFaceCount++,e.currentBufferFaces.push(t,r,a)}function N(e,t,r,a,i){if(e.materialManager.getCurrentMaterialID()!==e.previousMaterialID&&W(e),e.materialManager.currentRWXMaterial.geometrysampling==V.WIREFRAME){const n=new c;n.setAttribute("position",new B(new Float32Array([e.currentBufferVertices[3*t],e.currentBufferVertices[3*t+1],e.currentBufferVertices[3*t+2],e.currentBufferVertices[3*r],e.currentBufferVertices[3*r+1],e.currentBufferVertices[3*r+2],e.currentBufferVertices[3*a],e.currentBufferVertices[3*a+1],e.currentBufferVertices[3*a+2],e.currentBufferVertices[3*t],e.currentBufferVertices[3*t+1],e.currentBufferVertices[3*t+2],e.currentBufferVertices[3*a],e.currentBufferVertices[3*a+1],e.currentBufferVertices[3*a+2],e.currentBufferVertices[3*i],e.currentBufferVertices[3*i+1],e.currentBufferVertices[3*i+2]]),3)),n.computeVertexNormals();const s=new I(new F(n),new E({color:e.materialManager.currentRWXMaterial.getColorHexValue()}));e.currentGroup.add(s)}else e.currentBufferFaceCount+=2,e.currentBufferFaces.push(t,r,a),e.currentBufferFaces.push(t,a,i)}function k(e,t){e.materialManager.getCurrentMaterialID()!==e.previousMaterialID&&W(e);const[r,s,l]=function(e,t,r){const s=new i;let l=new n;const u=new f,o=new h,c=new i,m=new i,x=new i(1,0,0),d=new i(0,0,1);let M=new i,R=[],w=[],y=[],B=e.length/3,F={};s.setScalar(0);let I=r.length;for(let t=0;t<I;t++)s.add(new i(e[3*r[t]],e[3*r[t]+1],e[3*r[t]+2])),F[t]=r[t];s.multiplyScalar(1/I);let E=new i(0,0,0);for(let t=0;t<I;t++){const a=new i(e[3*r[t]],e[3*r[t]+1],e[3*r[t]+2]);let n=new i(e[3*r[(t+1)%I]],e[3*r[(t+1)%I]+1],e[3*r[(t+1)%I]+2]);E.x+=(a.y-n.y)*(a.z+n.z),E.y+=(a.z-n.z)*(a.x+n.x),E.z+=(a.x-n.x)*(a.y+n.y)}E.normalize();const T=new i(e[3*r[0]],e[3*r[0]+1],e[3*r[0]+2]);u.setFromNormalAndCoplanarPoint(E,T);let D=u.normal;o.setFromUnitVectors(d,D),m.copy(x).applyQuaternion(o),c.crossVectors(m,D),c.normalize(),l.makeBasis(m,c,D),l.setPosition(s);let V=[];for(let t=0;t<I;t++){const n=new i(e[3*r[t]],e[3*r[t]+1],e[3*r[t]+2]);M.subVectors(n,s),V.push(new a(M.dot(m),M.dot(c)))}let G=new g(V),b=new p(G);b.applyMatrix4(l);let v=b.getAttribute("position");const A=b.getIndex().array;for(let r=0,a=v.count;r<a;r++)v.setXYZ(r,e[3*F[r]],e[3*F[r]+1],e[3*F[r]+2]),w.push(t[2*F[r]],t[2*F[r]+1]);for(let e=0,t=A.length;e<t;e++)y.push(A[e]+B);return R.push(...v.array),[R,w,y]}(e.currentBufferVertices,e.currentBufferUVs,t);e.currentBufferVertices.push(...r),e.currentBufferUVs.push(...s);for(let t=0;t<l.length;t+=3){const r=l[t],a=l[t+1],i=l[t+2];e.currentBufferFaceCount++,e.currentBufferFaces.push(r,a,i)}}function H(e,t,r,a=null){if(r<3)throw"Need at least 3 sides to make a vertex circle";let n=[],s=[],l=new i;const u=2*Math.PI/r,o=new i(0,1,0);l.add(new i(t,0,0));for(let t=0;t<r;t++)n.push(l.x,l.y+e,l.z),l.applyAxisAngle(o,u),null===a?s.push((Math.cos(u*t)+1)/2,(Math.sin(u*t)+1)/2):s.push(1/r*t,a);return[n,s]}function z(e,t,a,i){let n=new c,s=e.materialManager.getCurrentMaterial().threeMat;void 0===s.flatShading||s.flatShading||(s=s.clone(),s.flatShading=!0);const l=[-t/2,a/2,-i/2,t/2,a/2,-i/2,t/2,a/2,i/2,-t/2,a/2,i/2,-t/2,-a/2,-i/2,t/2,-a/2,-i/2,t/2,-a/2,i/2,-t/2,-a/2,i/2];n.setAttribute("position",new B(new Float32Array(l),3)),n.setAttribute("uv",new B(new Float32Array([0,0,1,0,1,1,0,1,1,1,0,1,0,0,1,0]),2)),n.setIndex([0,3,1,1,3,2,0,4,3,3,4,7,3,6,2,3,7,6,6,7,5,5,7,4,1,5,0,0,5,4,2,5,1,6,5,2]),n.addGroup(0,36,0),n.uvsNeedUpdate=!0,n.computeVertexNormals();let u=new r(n,[s]);u.userData.taggedMaterials={},u.applyMatrix4(e.currentTransform),e.currentGroup.add(u)}function O(e,t,a,i){if(i<3)return;const n=i;let s=new c,[l,u]=H(0,a,n);l.push(0,t,0),u.push(.5,.5),s.setAttribute("position",new B(new Float32Array(l),3)),s.setAttribute("uv",new B(new Float32Array(u),2));let o=[];for(let e=0;e<n;e++)o.push(n,e,(e+1)%n);s.setIndex(o),s.addGroup(0,3*n,0),s.uvsNeedUpdate=!0,s.computeVertexNormals();let h=new r(s,[e.materialManager.getCurrentMaterial().threeMat]);h.userData.taggedMaterials={},h.applyMatrix4(e.currentTransform),e.currentGroup.add(h)}function P(e,t,a,i,n){if(n<3)return;const s=n;let[l,u]=H(0,a,s,1);const o=H(t,i,s,0);l.push(...o[0]),u.push(...o[1]);let h=new c;h.setAttribute("position",new B(new Float32Array(l),3)),h.setAttribute("uv",new B(new Float32Array(u),2));const f=s;let g=[];for(let e=0;e<s;e++)g.push(f+e,e,(e+1)%s),g.push(f+e,(e+1)%s,f+(e+1)%s);h.setIndex(g),h.addGroup(0,6*s,0),h.uvsNeedUpdate=!0,h.computeVertexNormals();let p=new r(h,[e.materialManager.getCurrentMaterial().threeMat]);p.userData.taggedMaterials={},p.applyMatrix4(e.currentTransform),e.currentGroup.add(p)}function j(e,t,a,i){if(i<3)return;const n=i;let s=new c,[l,u]=H(t,a,n);s.setAttribute("position",new B(new Float32Array(l),3)),s.setAttribute("uv",new B(new Float32Array(u),2));let o=[];for(let e=1;e<n;e++)o.push(0,e,(e+1)%n);s.setIndex(o),s.addGroup(0,3*n,0),s.uvsNeedUpdate=!0,s.computeVertexNormals();let h=new r(s,[e.materialManager.getCurrentMaterial().threeMat]);h.applyMatrix4(e.currentTransform),h.userData.taggedMaterials={},e.currentGroup.add(h)}function Z(e,t,a){if(a<2)return;const i=4*a,n=a,s=Math.PI/(2*n);let[l,u]=H(0,t,i,1),o=0,h=0,f=null,g=[];for(let e=1;e<n;e++){h=o+i;const r=Math.sin(s*e);f=H(r*t,Math.cos(s*e)*t,i,r),l.push(...f[0]),u.push(...f[1]);for(let e=0;e<i;e++)g.push(h+e,o+e,o+(e+1)%i),g.push(h+e,o+(e+1)%i,h+(e+1)%i);o=h}l.push(0,t,0),u.push(.5,0);const p=l.length/3-1;for(let e=0;e<i;e++)g.push(p,o+e,o+(e+1)%i);let m=new c;m.setAttribute("position",new B(new Float32Array(l),3)),m.setAttribute("uv",new B(new Float32Array(u),2)),m.setIndex(g),m.addGroup(0,m.getIndex().count,0),m.uvsNeedUpdate=!0,m.computeVertexNormals();let x=new r(m,[e.materialManager.getCurrentMaterial().threeMat]);x.userData.taggedMaterials={},x.applyMatrix4(e.currentTransform),e.currentGroup.add(x)}function q(e,t,a){if(a<2)return;let i=new T(t,4*a,2*a);i.addGroup(0,i.getIndex().count,0);let n=new r(i,[e.materialManager.getCurrentMaterial().threeMat]);n.userData.taggedMaterials={},n.applyMatrix4(e.currentTransform),e.currentGroup.add(n)}function _(e){let t=new y;t.userData.rwx={},t.applyMatrix4(e.currentTransform),e.currentGroup.add(t),e.currentGroup=t,e.currentTransform=new n}function Y(e){e.currentTransform=e.currentGroup.matrix.clone(),e.currentGroup=e.currentGroup.parent}function J(e){e.materialStack.push(e.materialManager.currentRWXMaterial),e.materialManager.currentRWXMaterial=e.materialManager.currentRWXMaterial.clone(),e.materialManager.resetCurrentMaterialList(e.materialManager.currentRWXMaterial)}function Q(e){e.materialManager.currentRWXMaterial=e.materialStack.pop(),e.materialManager.resetCurrentMaterialList(e.materialManager.currentRWXMaterial)}function K(e){e.transformSaves.push(e.currentTransform.clone())}function ee(e){e.transformSaves.length>0?e.currentTransform=e.transformSaves.pop():e.currentTransform=new n}function te(e,t){e.materialManager.currentRWXMaterial.tag=t,void 0===e.taggedMaterials[t.toString()]&&(e.taggedMaterials[t.toString()]=[]),e.taggedMaterials[t.toString()].includes(e.materialManager.getCurrentMaterialID())||e.taggedMaterials[t.toString()].push(e.materialManager.getCurrentMaterialID())}function re(e){e.materialManager.currentRWXMaterial.tag=0}function ae(e,t,r,n,s=null){const l=new i(e.currentBufferVertices[3*t],e.currentBufferVertices[3*t+1],e.currentBufferVertices[3*t+2]),u=new i(e.currentBufferVertices[3*r],e.currentBufferVertices[3*r+1],e.currentBufferVertices[3*r+2]),o=new i(e.currentBufferVertices[3*n],e.currentBufferVertices[3*n+1],e.currentBufferVertices[3*n+2]),c=new a(e.currentBufferUVs[2*t],e.currentBufferUVs[2*t+1]),h=new a(e.currentBufferUVs[2*r],e.currentBufferUVs[2*r+1]),f=new a(e.currentBufferUVs[2*n],e.currentBufferUVs[2*n+1]),g=Math.max(c.x,h.x,f.x),p=Math.max(c.y,h.y,f.y),m=Math.min(c.x,h.x,f.x),x=(g+m)/2,d=1/(g-m),M=1/(p-Math.min(c.y,h.y,f.y));let R=1,w=1,y=o,B=f,F=[l,u],I=[c,h],E=l.distanceToSquared(u);const T=l.distanceToSquared(o),D=u.distanceToSquared(o);T>E&&(E=T,y=u,F=[l,o],B=h,I=[c,f]),D>E&&(E=D,y=l,F=[u,o],B=c,I=[h,f]),B.x<x&&(I[0].x>x?(R=y.distanceTo(F[0]),w=y.distanceTo(F[1])):(R=y.distanceTo(F[1]),w=y.distanceTo(F[0]))),B.x>x&&(I[0].x<x?(R=y.distanceTo(F[0]),w=y.distanceTo(F[1])):(R=y.distanceTo(F[1]),w=y.distanceTo(F[0])));const V=R*d/(w*M);if(e.materialManager.currentRWXMaterial.ratio=V,null===s)if(null===e.triangleRatioHint)e.triangleRatioHint=V;else{const t=V-e.triangleRatioHint,r=t*t;e.materialManager.currentRWXMaterial.ratio=r<.09?e.triangleRatioHint:V}else if(null===e.quadRatioHint)e.quadRatioHint=V;else{const t=V-e.quadRatioHint,r=t*t;e.materialManager.currentRWXMaterial.ratio=r<.09?e.quadRatioHint:V}}function ie(e){e.materialManager.currentRWXMaterial.ratio=1}function ne(e,t,a=e.matrix){e.children.forEach((e=>{let i=new n;if(i.copy(a),i.multiply(e.matrix),e instanceof r&&t.meshFilter(e)){let r=[];const a=e.geometry.getIndex().array;if("function"==typeof e.material[Symbol.iterator]){e.geometry.groups.forEach((e=>{r.push({start:e.start+t.indices.length,count:e.count,materialIndex:e.materialIndex+t.materials.length})}));const a=e.userData.taggedMaterials;if(void 0!==a)for(const[e,r]of Object.entries(a))void 0===t.taggedMaterials[e]&&(t.taggedMaterials[e]=[]),r.forEach((r=>{t.taggedMaterials[e].push(r+t.materials.length)}));t.materials.push(...e.material)}else r.push({start:t.indices.length,count:a.length,materialIndex:t.materials.length}),t.materials.push(e.material);const n=e.geometry.getAttribute("position").array,l=t.positions.length/3;let u=0;for(let e=n.length/3;u<e;u++){let e=new s(n[3*u],n[3*u+1],n[3*u+2]);e.applyMatrix4(i),t.positions.push(e.x),t.positions.push(e.y),t.positions.push(e.z)}if(void 0===e.geometry.getAttribute("uv")){const e=new Array(2*u).fill(0);t.uvs.push(...e)}else t.uvs.push(...e.geometry.getAttribute("uv").array);t.indices.push(...a.map((e=>e+l))),r.forEach((e=>{t.bufferGeometry.addGroup(e.start,e.count,e.materialIndex)}))}else e instanceof y&&ne(e,t,i)}))}function se(e,t=(()=>!0)){let a={bufferGeometry:new c,positions:[],uvs:[],indices:[],materials:[],taggedMaterials:{},meshFilter:t};ne(e,a),a.bufferGeometry.setAttribute("position",new B(new Float32Array(a.positions),3)),a.bufferGeometry.setAttribute("uv",new B(new Float32Array(a.uvs),2)),a.bufferGeometry.setIndex(a.indices),a.bufferGeometry.uvsNeedUpdate=!0,a.bufferGeometry.computeVertexNormals();let i=new r(a.bufferGeometry,a.materials);return i.userData.rwx=e.userData.rwx,i.userData.taggedMaterials=a.taggedMaterials,i}class le{constructor(){this.color=[0,0,0],this.surface=[.69,0,0],this.opacity=1,this.lightsampling=D.FACET,this.geometrysampling=V.SOLID,this.texturemodes=[G.LIT],this.materialmode=b.NULL,this.texture=null,this.mask=null,this.collision=!0,this.tag=0,this.ratio=1}clone(){let e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e.color=[...this.color],e.surface=[...this.surface],e.texturemodes=[...this.texturemodes],e}getColorHexValue(){return(Math.trunc(255*this.color[0])<<16)+(Math.trunc(255*this.color[1])<<8)+Math.trunc(255*this.color[2])}getMatSignature(){const e=this.color[0].toFixed(3)+this.color[1].toFixed(3)+this.color[2].toFixed(3),t=this.surface[0].toFixed(3)+this.surface[1].toFixed(3)+this.surface[2].toFixed(3),r=this.opacity.toFixed(3),a=this.lightsampling.toString(),i=this.geometrysampling.toString();let n="";this.texturemodes.forEach((e=>{n+=e.toString()}));const s=this.materialmode.toString(),l=null===this.texture?"":this.texture,u=null===this.mask?"":this.mask,o=this.collision.toString(),c=this.tag.toString(),h=this.ratio.toFixed(2);return`${e}_${t}_${r}_${a}_${i}_${n}_${s}_${l}_${u}_${o}_${c}_${h}`}}class ue{constructor(e,t=".jpg",r=".zip",a=null,i=null,n=!1,s=M){this.folder=e,this.textureExtension=t,this.maskExtension=r,this.jsZip=a,this.jsZipUtils=i,this.currentRWXMaterial=new le,this.threeMaterialMap={},this.currentMaterialID=null,this.currentMaterialList=[],this.signatureMap={},this.commitedMaterialsAmount=0,this.currentMaterialSignature="",this.useBasicMaterial=n,this.textureEncoding=s}getCurrentMaterialID(){const e=this.currentRWXMaterial.getMatSignature();return void 0!==this.signatureMap[e]?(this.currentMaterialSignature=e,this.signatureMap[e]):(void 0===this.threeMaterialMap[e]&&(this.threeMaterialMap[e]=L(this.currentRWXMaterial,this.folder,this.textureExtension,this.maskExtension,this.jsZip,this.jsZipUtils,this.useBasicMaterial,this.textureEncoding),this.threeMaterialMap[e].needsUpdate=!0,this.threeMaterialMap[e].signature=e),this.currentMaterialSignature!=e&&(this.currentMaterialSignature=e,null===this.currentMaterialID?this.currentMaterialID=0:this.currentMaterialID++,this.signatureMap[e]=this.currentMaterialID,this.currentMaterialList.push(this.threeMaterialMap[e])),this.currentMaterialID)}getCurrentMaterial(){return this.currentMaterialList[this.getCurrentMaterialID()]}getCurrentMaterialList(){return this.currentMaterialList}resetCurrentMaterialList(e=new le){this.currentMaterialID=null,this.currentMaterialList=[],this.signatureMap={},this.currentMaterialSignature="",this.currentRWXMaterial=e,this.commitedMaterialsAmount=0}texturesNextFrame(){for(const e of Object.entries(this.threeMaterialMap)){const t=e[1].threeMat.userData.rwx.animation;void 0!==t&&(t.step=(t.step+1)%t.yTiles,e[1].threeMat.map.offset.y=1-t.yHeight-t.step*t.yHeight,e[1].threeMat.needsUpdate=!0)}}commitMaterials(){this.commitedMaterialsAmount=this.currentMaterialList.length}getCommitedMaterialList(){return this.currentMaterialList.slice(0,this.commitedMaterialsAmount)}}export default class extends t{constructor(e){super(e),this.integerRegex=/([-+]?[0-9]+)/g,this.floatRegex=/([+-]?([0-9]+([.][0-9]*)?|[.][0-9]+))/g,this.nonCommentRegex=/^(.*)#/g,this.clumpbeginRegex=/^ *(clumpbegin).*$/i,this.clumpendRegex=/^ *(clumpend).*$/i,this.transformbeginRegex=/^ *(transformbegin).*$/i,this.transformendRegex=/^ *(transformend).*$/i,this.protobeginRegex=/^ *(protobegin) +([A-Za-z0-9_\-\.]+).*$/i,this.protoinstanceRegex=/^ *(protoinstance) +([A-Za-z0-9_\-\.]+).*$/i,this.protoendRegex=/^ *(protoend).*$/i,this.vertexRegex=/^ *(vertex|vertexext)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){3}) *(uv(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){2}))?.*$/i,this.polygonRegex=/^ *(polygon|polygonext)( +[0-9]+)(( +[0-9]+)+)( +tag +([0-9]+))?.*$/i,this.quadRegex=/^ *(quad|quadext)(( +([0-9]+)){4})( +tag +([0-9]+))?.*$/i,this.triangleRegex=/^ *(triangle|triangleext)(( +([0-9]+)){3})( +tag +([0-9]+))?.*$/i,this.textureRegex=/^ *(texture) +([A-Za-z0-9_\-]+) *(mask *([A-Za-z0-9_\-]+))?.*$/i,this.colorRegex=/^ *(color)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){3}).*$/i,this.opacityRegex=/^ *(opacity)( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)).*$/i,this.identityRegex=/^ *(identity) *$/i,this.transformRegex=/^ *(transform)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){16}).*$/i,this.translateRegex=/^ *(translate)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){3}).*$/i,this.scaleRegex=/^ *(scale)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){3}).*$/i,this.rotateRegex=/^ *(rotate)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){4})$/i,this.surfaceRegex=/^ *(surface)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){3}).*$/i,this.ambientRegex=/^ *(ambient)( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)).*$/i,this.diffuseRegex=/^ *(diffuse)( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)).*$/i,this.specularRegex=/^ *(specular)( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)).*$/i,this.materialModeRegex=/^ *((add)?materialmode(s)?) +([A-Za-z0-9_\-]+).*$/i,this.collisionRegex=/^ *(collision) +(on|off).*$/i,this.lightsamplingRegex=/^ *(lightsampling) +(facet|vertex).*$/i,this.geometrysamplingRegex=/^ *(geometrysampling) +(pointcloud|wireframe|solid).*$/i,this.axisalignmentRegex=/^ *(axisalignment) +(none|zorientx|zorienty|xyz).*$/i,this.blockRegex=/^ *(block)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){3}).*$/i,this.coneRegex=/^ *(cone)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){2}( +[-+]?[0-9]+)).*$/i,this.cylinderRegex=/^ *(cylinder)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){3}( +[-+]?[0-9]+)).*$/i,this.discRegex=/^ *(disc)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+)){2}( +[-+]?[0-9]+)).*$/i,this.hemisphereRegex=/^ *(hemisphere)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+))( +[-+]?[0-9]+)).*$/i,this.sphereRegex=/^ *(sphere)(( +[+-]?([0-9]+([.][0-9]*)?|[.][0-9]+))( +[-+]?[0-9]+)).*$/i,this.tagRegex=/^ *(tag)( +[-+]?[0-9]+).*$/i,this.jsZip=null,this.jsZipUtils=null,this.textureExtension=".jpg",this.maskExtension=".zip",this.waitFullLoad=!1,this.flatten=!1,this.useBasicMaterial=!1,this.rwxMaterialManager=null,this.textureEncoding=M,this.enableTextures=!0}setJSZip(e,t){return this.jsZip=e,this.jsZipUtils=t,this}setTextureExtension(e){return this.textureExtension=e,this}setMaskExtension(e){return this.maskExtension=e,this}setWaitFullLoad(e){return this.waitFullLoad=e,this}setFlatten(e){return this.flatten=e,this}setUseBasicMaterial(e){return this.useBasicMaterial=e,this}setRWXMaterialManager(e){return this.rwxMaterialManager=e,this}setTextureEncoding(e){return this.textureEncoding=e,this}setEnableTextures(e){return this.enableTextures=e,this}load(t,r,a,i){let n=this,s=this.path,l=this.resourcePath,u=new e(this.manager);u.setRequestHeader(this.requestHeader),u.setWithCredentials(this.withCredentials),u.load(s+"/"+t,(function(e){try{n.parse(e,l,(function(e){r(e)}))}catch(e){i?i(e):console.error(e),n.manager.itemError(t)}}),a,i)}parse(e,t,r){let a={rootGroup:null,currentGroup:null,transformSaves:[],materialStack:[],currentTransform:new n,currentBufferGeometry:null,currentBufferVertices:[],currentBufferUVs:[],currentBufferFaces:[],currentBufferFaceCount:0,currentBufferGroupFirstFaceID:0,previousMaterialID:null,rwxClumpStack:[],rwxProtoDict:{},loadingPromises:[],materialManager:null!==this.rwxMaterialManager?this.rwxMaterialManager:new ue(t,this.textureExtension,this.maskExtension,this.jsZip,this.jsZipUtils,this.useBasicMaterial,this.textureEncoding),taggedMaterials:{},quadRatioHint:null,triangleRatioHint:null},i=null,u=null;const o=new n;o.makeScale(10,10,10);const c=e.split(/[\n\r]+/g);a.rootGroup=new y,a.rootGroup.userData.rwx={axisAlignment:"none"},a.currentGroup=a.rootGroup,a.materialStack.push(a.materialManager.currentMaterial);for(let e=0,t=c.length;e<t;e++){let t=c[e],r=this.nonCommentRegex.exec(t);if(null!=r&&(t=r[1]),t=t.trim().replace(/\t/g," "),r=this.clumpbeginRegex.exec(t),null==r)if(r=this.clumpendRegex.exec(t),null==r)if(r=this.transformbeginRegex.exec(t),null==r)if(r=this.transformendRegex.exec(t),null==r)if(r=this.protobeginRegex.exec(t),null==r)if(r=this.protoendRegex.exec(t),null==r)if(r=this.protoinstanceRegex.exec(t),null==r)if(r=this.textureRegex.exec(t),this.enableTextures&&null!=r){const e=r[2].toLowerCase();a.materialManager.currentRWXMaterial.texture="null"==e?null:e,void 0!==r[4]?a.materialManager.currentRWXMaterial.mask=r[4]:a.materialManager.currentRWXMaterial.mask=null}else if(r=this.triangleRegex.exec(t),null==r)if(a.triangleRatioHint=null,r=this.quadRegex.exec(t),null==r)if(a.quadRatioHint=null,r=this.polygonRegex.exec(t),null==r)if(r=this.vertexRegex.exec(t),null==r)if(r=this.colorRegex.exec(t),null==r)if(r=this.opacityRegex.exec(t),null==r)if(r=this.identityRegex.exec(t),null!=r&&a.currentTransform.identity(),r=this.transformRegex.exec(t),null==r)if(r=this.translateRegex.exec(t),null==r)if(r=this.rotateRegex.exec(t),null==r)if(r=this.scaleRegex.exec(t),null==r)if(r=this.surfaceRegex.exec(t),null==r)if(r=this.ambientRegex.exec(t),null==r)if(r=this.diffuseRegex.exec(t),null==r)if(r=this.specularRegex.exec(t),null==r)if(r=this.materialModeRegex.exec(t),null==r)if(r=this.collisionRegex.exec(t),null==r)if(r=this.lightsamplingRegex.exec(t),null==r)if(r=this.geometrysamplingRegex.exec(t),null==r)if(r=this.axisalignmentRegex.exec(t),null==r)if(r=this.blockRegex.exec(t),null==r)if(r=this.coneRegex.exec(t),null==r)if(r=this.cylinderRegex.exec(t),null==r)if(r=this.discRegex.exec(t),null==r)if(r=this.hemisphereRegex.exec(t),null==r)if(r=this.sphereRegex.exec(t),null==r)r=this.tagRegex.exec(t),null==r||(a.currentGroup.userData.rwx.tag=parseInt(r[2]));else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(1==r?parseInt(t):parseFloat(t))})),q(a,e[0],e[1])}else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(1==r?parseInt(t):parseFloat(t))})),Z(a,e[0],e[1])}else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(2==r?parseInt(t):parseFloat(t))})),j(a,e[0],e[1],e[2])}else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(3==r?parseInt(t):parseFloat(t))})),P(a,e[0],e[1],e[2],e[3])}else{let e=[];r[2].match(this.floatRegex).forEach(((t,r)=>{e.push(2==r?parseInt(t):parseFloat(t))})),O(a,e[0],e[1],e[2])}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),z(a,e[0],e[1],e[2])}else a.rootGroup.userData.rwx.axisAlignment=r[2].toLowerCase();else{const e=r[2].toLowerCase();a.materialManager.currentRWXMaterial.geometrysampling="pointcloud"==e?V.POINTCLOUD:"wireframe"==e?V.WIREFRAME:V.SOLID}else{const e=r[2].toLowerCase();a.materialManager.currentRWXMaterial.lightsampling="vertex"==e?D.VERTEX:D.FACET}else{const e=r[2].toLowerCase();"on"==e?a.materialManager.currentRWXMaterial.collision=!0:"off"==e&&(a.materialManager.currentRWXMaterial.collision=!1)}else{const e=r[4].toLowerCase();"none"==e?a.materialManager.currentRWXMaterial.materialmode=b.NONE:"null"==e?a.materialManager.currentRWXMaterial.materialmode=b.NULL:"double"==e&&(a.materialManager.currentRWXMaterial.materialmode=b.DOUBLE)}else a.materialManager.currentRWXMaterial.surface[2]=parseFloat(r[2]);else a.materialManager.currentRWXMaterial.surface[1]=parseFloat(r[2]);else a.materialManager.currentRWXMaterial.surface[0]=parseFloat(r[2]);else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),a.materialManager.currentRWXMaterial.surface=e}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))}));let t=new n;3==e.length&&(t.makeScale(e[0],e[1],e[2]),a.currentTransform.multiply(t))}else{let e=[];if(r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),4==e.length){let t=new n;e[0]&&(t.makeRotationX(l.degToRad(e[0]*e[3])),a.currentTransform.multiply(t)),e[1]&&(t.makeRotationY(l.degToRad(e[1]*e[3])),a.currentTransform.multiply(t)),e[2]&&(t.makeRotationZ(l.degToRad(e[2]*e[3])),a.currentTransform.multiply(t))}}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))}));let t=new n;3==e.length&&(t.makeTranslation(e[0],e[1],e[2]),a.currentTransform.multiply(t))}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),16==e.length&&(0==e[15]&&(e[15]=1),a.currentTransform.fromArray(e))}else a.materialManager.currentRWXMaterial.opacity=parseFloat(r[2]);else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),3==e.length&&(a.materialManager.currentRWXMaterial.color=e)}else{let e=[];r[2].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))}));let t=new s(e[0],e[1],e[2]);if(t.applyMatrix4(a.currentTransform),a.currentBufferVertices.push(t.x,t.y,t.z),void 0!==r[7]){let e=[];r[7].match(this.floatRegex).forEach((t=>{e.push(parseFloat(t))})),a.currentBufferUVs.push(e[0],1-e[1])}else a.currentBufferUVs.push(0,0)}else{const e=parseInt(r[2].match(this.integerRegex)[0]);let t=[];const i=r[3].match(this.integerRegex);for(let r=0;r<e;r++){const e=i[r];t.unshift(parseInt(e)-1)}const n=r.slice(-1)[0];void 0!==n&&te(a,parseInt(n)),k(a,t),void 0!==n&&re(a)}else{let e=[];r[2].match(this.integerRegex).forEach((t=>{e.push(parseInt(t)-1)}));const t=r.slice(-1)[0];void 0!==t?(100==t?ae(a,e[0],e[1],e[2],e[3]):a.quadRatioHint=null,te(a,parseInt(t))):a.quadRatioHint=null,N(a,e[0],e[1],e[2],e[3]),void 0!==t&&(re(a),ie(a))}else{let e=[];r[2].match(this.integerRegex).forEach((t=>{e.push(parseInt(t)-1)}));const t=r.slice(-1)[0];void 0!==t?(100==t?ae(a,e[0],e[1],e[2]):a.triangleRatioHint=null,te(a,parseInt(t))):a.triangleRatioHint=null,X(a,e[0],e[1],e[2]),void 0!==t&&(re(a),ie(a))}else{const e=r[2],t=a.rwxProtoDict[e].clone();t.applyMatrix4(a.currentTransform),a.currentGroup.add(t)}else U(a),a.currentGroup=u,a.currentTransform=i,Q(a),$(a);else{let e=r[2];u=a.currentGroup,i=a.currentTransform,J(a),a.rwxProtoDict[e]=new y,a.rwxProtoDict[e].userData.rwx={},a.currentTransform=new n,$(a),a.currentGroup=a.rwxProtoDict[e]}else ee(a);else K(a);else U(a),Q(a),Y(a),$(a);else U(a),$(a),_(a),J(a)}a.materialManager.resetCurrentMaterialList(),a.rootGroup.applyMatrix4(o),this.waitFullLoad?Promise.all(a.loadingPromises).then((()=>{r(this.flatten?se(a.rootGroup):a.rootGroup)})):r(this.flatten?se(a.rootGroup):a.rootGroup)}}export{le as RWXMaterial,ue as RWXMaterialManager,L as makeThreeMaterial,C as makeMaskPromise,S as applyTextureToMat,D as LightSampling,V as GeometrySampling,G as TextureMode,b as MaterialMode,v as signTag,A as pictureTag,se as flattenGroup};
